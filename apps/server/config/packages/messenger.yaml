framework:
    messenger:
        failure_transport: failed

        transports:
            # General async tasks (emails, notifications)
            async:
                dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                options:
                    queue_name: async        # Doctrine
                    stream: async            # Redis
                    group: async             # Redis consumer group
                retry_strategy:
                    max_retries: 3
                    multiplier: 2

            # Query execution - separate for fast interactive queries
            async_query:
                dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                options:
                    queue_name: async_query  # Doctrine
                    stream: async_query      # Redis
                    group: async_query       # Redis consumer group
                retry_strategy:
                    max_retries: 3
                    multiplier: 2

            # Event processing/parquet writes - high volume, can scale independently
            async_events:
                dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                options:
                    queue_name: async_events  # Doctrine
                    stream: async_events      # Redis
                    group: async_events       # Redis consumer group
                retry_strategy:
                    max_retries: 3
                    multiplier: 2

            # Parquet compaction - memory intensive, separate worker
            async_compaction:
                dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                options:
                    queue_name: async_compaction  # Doctrine
                    stream: async_compaction      # Redis
                    group: async_compaction       # Redis consumer group
                retry_strategy:
                    max_retries: 3
                    multiplier: 2

            failed: 'doctrine://default?queue_name=failed'

        default_bus: messenger.bus.default

        buses:
            messenger.bus.default:
                middleware:
                    - App\Messenger\Middleware\DebugLoggingMiddleware
                    - App\Messenger\Middleware\TimeoutMiddleware
                    - App\Messenger\Middleware\TraceContextMiddleware

        routing:
            # General async
            Symfony\Component\Mailer\Messenger\SendEmailMessage: async
            Symfony\Component\Notifier\Message\ChatMessage: async
            Symfony\Component\Notifier\Message\SmsMessage: async

            # Event processing - high volume writes
            App\Message\ProcessEventBatch: async_events
            # Legacy single event processing (kept for backward compatibility)
            App\Message\ProcessEvent: async_events

            # Query execution - interactive, needs fast response
            App\Message\ExecuteQuery: async_query
            App\Message\ComputeFacetBatch: async_query

            # Scheduled tasks - compaction, maintenance
            App\Message\CompactParquet: async_compaction

when@test:
    framework:
        messenger:
            transports:
                async: 'test://'
                async_query: 'test://'
                async_events: 'test://'
                async_compaction: 'test://'
