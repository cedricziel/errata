framework:
    messenger:
        failure_transport: failed

        default_bus: messenger.bus.default

        buses:
            messenger.bus.default:
                middleware:
                    - App\Messenger\Middleware\DebugLoggingMiddleware
                    - App\Messenger\Middleware\TimeoutMiddleware
                    - App\Messenger\Middleware\TraceContextMiddleware

        routing:
            # General async
            Symfony\Component\Mailer\Messenger\SendEmailMessage: async
            Symfony\Component\Notifier\Message\ChatMessage: async
            Symfony\Component\Notifier\Message\SmsMessage: async

            # Event processing - high volume writes
            App\Message\ProcessEventBatch: async_events
            # Legacy single event processing (kept for backward compatibility)
            App\Message\ProcessEvent: async_events

            # Query execution - interactive, needs fast response
            App\Message\ExecuteQuery: async_query
            App\Message\ComputeFacetBatch: async_query

            # Scheduled tasks - compaction, maintenance
            App\Message\CompactParquet: async_compaction

# Development: Use Doctrine transport (no Redis required)
when@dev:
    framework:
        messenger:
            transports:
                async:
                    dsn: 'doctrine://default'
                    options:
                        queue_name: async
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                async_query:
                    dsn: 'doctrine://default'
                    options:
                        queue_name: async_query
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                async_events:
                    dsn: 'doctrine://default'
                    options:
                        queue_name: async_events
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                async_compaction:
                    dsn: 'doctrine://default'
                    options:
                        queue_name: async_compaction
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                failed: 'doctrine://default?queue_name=failed'

# Production: Use Redis transport (scalable)
when@prod:
    framework:
        messenger:
            transports:
                async:
                    dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                    options:
                        stream: async
                        group: async
                        delete_after_ack: false
                        delete_after_reject: false
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                async_query:
                    dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                    options:
                        stream: async_query
                        group: async_query
                        delete_after_ack: false
                        delete_after_reject: false
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                async_events:
                    dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                    options:
                        stream: async_events
                        group: async_events
                        delete_after_ack: false
                        delete_after_reject: false
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                async_compaction:
                    dsn: '%env(MESSENGER_TRANSPORT_DSN)%'
                    options:
                        stream: async_compaction
                        group: async_compaction
                        delete_after_ack: false
                        delete_after_reject: false
                    retry_strategy:
                        max_retries: 3
                        multiplier: 2

                failed: 'doctrine://default?queue_name=failed'

# Test: Use in-memory sync transport
when@test:
    framework:
        messenger:
            transports:
                async: 'test://'
                async_query: 'test://'
                async_events: 'test://'
                async_compaction: 'test://'
                failed: 'test://'
