#cloud-config
# Infrastructure server: PostgreSQL 16 + Redis

package_update: true
package_upgrade: true

packages:
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades

# Create deploy user
users:
  - name: deploy
    groups: sudo
    shell: /bin/bash
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    ssh_authorized_keys:
      - ${ssh_public_key}

write_files:
  # PostgreSQL configuration for remote access
  - path: /etc/postgresql/16/main/conf.d/custom.conf
    content: |
      listen_addresses = '*'
      max_connections = 100
      shared_buffers = 256MB
      effective_cache_size = 768MB
      maintenance_work_mem = 64MB
      checkpoint_completion_target = 0.9
      wal_buffers = 8MB
      default_statistics_target = 100
      random_page_cost = 1.1
      effective_io_concurrency = 200
    defer: true

  # PostgreSQL HBA for private network access
  - path: /tmp/pg_hba_append.conf
    content: |
      # Allow connections from private network
      host    all             all             10.0.0.0/16             scram-sha-256

  # Redis configuration
  - path: /etc/redis/redis.conf.d/custom.conf
    content: |
      bind 0.0.0.0
      protected-mode yes
      maxmemory 256mb
      maxmemory-policy allkeys-lru
    defer: true

  # UFW rules script
  - path: /tmp/setup-firewall.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      ufw default deny incoming
      ufw default allow outgoing
      ufw allow 22/tcp
      ufw allow from 10.0.0.0/16 to any port 5432
      ufw allow from 10.0.0.0/16 to any port 6379
      ufw --force enable

runcmd:
  # Install PostgreSQL 16 repository
  - sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
  - curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
  - apt-get update

  # Install PostgreSQL 16
  - apt-get install -y postgresql-16 postgresql-contrib-16

  # Install Redis
  - apt-get install -y redis-server

  # Configure PostgreSQL
  - mkdir -p /etc/postgresql/16/main/conf.d
  - cat /tmp/pg_hba_append.conf >> /etc/postgresql/16/main/pg_hba.conf
  - systemctl restart postgresql

  # Create errata database and user
  - sudo -u postgres psql -c "CREATE USER errata WITH PASSWORD '${postgres_password}';"
  - sudo -u postgres psql -c "CREATE DATABASE errata OWNER errata;"
  - sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE errata TO errata;"

  # Configure Redis
  - mkdir -p /etc/redis/redis.conf.d
  - |
    if [ -n "${redis_password}" ]; then
      echo "requirepass ${redis_password}" >> /etc/redis/redis.conf.d/custom.conf
    fi
  - echo "include /etc/redis/redis.conf.d/*.conf" >> /etc/redis/redis.conf
  - systemctl restart redis-server

  # Setup firewall
  - /tmp/setup-firewall.sh

  # Enable automatic security updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades

final_message: "Infrastructure server setup complete after $UPTIME seconds"
