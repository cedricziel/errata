#cloud-config
# Web server: Nginx + PHP 8.5 FPM

package_update: true
package_upgrade: true

packages:
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades
  - git
  - acl

# Create deploy user
users:
  - name: deploy
    groups: sudo,www-data
    shell: /bin/bash
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    ssh_authorized_keys:
      - ${ssh_public_key}

write_files:
  # Nginx site configuration
  - path: /etc/nginx/sites-available/errata
    content: |
      server {
          listen 80;
          server_name ${domain};
          root /var/www/errata/current/public;

          location / {
              try_files $uri /index.php$is_args$args;
          }

          location ~ ^/index\.php(/|$) {
              fastcgi_pass unix:/var/run/php/php8.5-fpm.sock;
              fastcgi_split_path_info ^(.+\.php)(/.*)$;
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
              fastcgi_param DOCUMENT_ROOT $realpath_root;
              internal;
          }

          location ~ \.php$ {
              return 404;
          }

          location /health {
              access_log off;
              return 200 "OK";
              add_header Content-Type text/plain;
          }

          error_log /var/log/nginx/errata_error.log;
          access_log /var/log/nginx/errata_access.log;
      }
    defer: true

  # PHP-FPM pool configuration
  - path: /etc/php/8.5/fpm/pool.d/errata.conf
    content: |
      [errata]
      user = www-data
      group = www-data
      listen = /var/run/php/php8.5-fpm.sock
      listen.owner = www-data
      listen.group = www-data
      pm = dynamic
      pm.max_children = 10
      pm.start_servers = 3
      pm.min_spare_servers = 2
      pm.max_spare_servers = 5
      pm.max_requests = 500
      php_admin_value[error_log] = /var/log/php/errata-error.log
      php_admin_flag[log_errors] = on
      catch_workers_output = yes
      php_value[opcache.enable] = 1
      php_value[opcache.memory_consumption] = 256
      php_value[opcache.max_accelerated_files] = 20000
      php_value[realpath_cache_size] = 4096K
      php_value[realpath_cache_ttl] = 600
    defer: true

  # UFW rules script
  - path: /tmp/setup-firewall.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      ufw default deny incoming
      ufw default allow outgoing
      ufw allow 22/tcp
      ufw allow 80/tcp
      ufw allow 443/tcp
      ufw --force enable

  # Deployer directory setup script
  - path: /tmp/setup-deployer.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      mkdir -p /var/www/errata/{releases,shared}
      mkdir -p /var/www/errata/shared/{var/log,var/data,storage}
      chown -R deploy:www-data /var/www/errata
      chmod -R 775 /var/www/errata
      setfacl -dR -m u:www-data:rwX /var/www/errata/shared
      setfacl -R -m u:www-data:rwX /var/www/errata/shared

runcmd:
  # Add PHP repository
  - add-apt-repository -y ppa:ondrej/php
  - apt-get update

  # Install Nginx
  - apt-get install -y nginx

  # Install PHP 8.5 and extensions
  - apt-get install -y php8.5-fpm php8.5-cli php8.5-common php8.5-curl php8.5-mbstring php8.5-xml php8.5-zip php8.5-pgsql php8.5-redis php8.5-intl php8.5-opcache php8.5-apcu

  # Create PHP log directory
  - mkdir -p /var/log/php
  - chown www-data:www-data /var/log/php

  # Configure Nginx
  - rm -f /etc/nginx/sites-enabled/default
  - ln -sf /etc/nginx/sites-available/errata /etc/nginx/sites-enabled/errata
  - rm -f /etc/php/8.5/fpm/pool.d/www.conf

  # Setup deployer directories
  - /tmp/setup-deployer.sh

  # Install Composer
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

  # Start services
  - systemctl enable nginx php8.5-fpm
  - systemctl restart nginx php8.5-fpm

  # Setup firewall
  - /tmp/setup-firewall.sh

  # Enable automatic security updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades

final_message: "Web server setup complete after $UPTIME seconds"
